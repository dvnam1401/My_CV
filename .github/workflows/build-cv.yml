name: Build LaTeX CV

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install TeX Live and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            fonts-font-awesome \
            biber \
            latexmk \
            make

      - name: Ensure minimal bibliography file (no changes to cv.tex)
        # Create an empty citations.bib if it doesn't exist so bibliography tools
        # don't bail with "missing .bbl" when a .bcf/.aux references nothing.
        run: |
          if [ ! -f citations.bib ]; then
            echo "% Empty bibliography (created by CI) to avoid missing bbl errors" > citations.bib
          fi

      - name: Clean previous build artifacts
        run: |
          rm -f *.aux *.bbl *.bcf *.blg *.fdb_latexmk *.fls *.log *.out *.run.xml *.toc *.pdf

      - name: Compile LaTeX document using Makefile
        run: |
          # Chạy lệnh make all để sử dụng cấu hình trong Makefile
          # Lệnh này sẽ tạo ra file Dang_Van_Nam_CV.pdf
          make all
          
          # Kiểm tra xem file PDF tên mới đã được tạo chưa
          if [ ! -f Dang_Van_Nam_CV.pdf ]; then
            echo "❌ Dang_Van_Nam_CV.pdf was NOT generated. Checking logs..."
            if [ -f cv.log ]; then
              sed -n '1,200p' cv.log || true
            fi
            exit 1
          else
            echo "✅ Dang_Van_Nam_CV.pdf generated successfully."
            ls -lh Dang_Van_Nam_CV.pdf
          fi

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: false
          cname: www.dangvannam.id.vn
